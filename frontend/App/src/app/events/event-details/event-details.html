<div class="event-details-container">
  <ng-container *ngIf="isLoading">
    <mat-card><p>Loading event details...</p></mat-card>
  </ng-container>
  <ng-container *ngIf="error">
    <mat-card><p class="error">{{ error }}</p></mat-card>
  </ng-container>
  <ng-container *ngIf="!isLoading && !error && event">
    <!-- Event Header -->
    <mat-card class="event-header-card">
      <div class="header-map">
        <iframe 
          *ngIf="event.latitude && event.longitude"
          [src]="getMapUrl()" 
          width="100%" 
          height="180" 
          style="border:0;" 
          allowfullscreen="" 
          loading="lazy" 
          referrerpolicy="no-referrer-when-downgrade">
        </iframe>
        <div *ngIf="!event.latitude || !event.longitude" class="no-map">
          <mat-icon>location_off</mat-icon>
          <p>Location not available</p>
        </div>
      </div>
      <div class="event-header-content">
        <h2>{{ event.title }}</h2>
        <div class="tags">
          <span class="tag level">{{ event.level }}</span>
        </div>

        <div class="details">
          <div class="info-item">
            <mat-icon>event</mat-icon>
            <span><strong>Date & Time:</strong> {{ event.date || event.startTime }}</span>
          </div>
          <div class="info-item">
            <mat-icon>location_on</mat-icon>
            <span><strong>Location:</strong> {{ event.location || event.address }}</span>
          </div>
          <div class="info-item">
            <mat-icon>groups</mat-icon>
            <span><strong>Participants:</strong> {{ event.participantsCount || (event.participants?.length + '/' + event.capacity) }}</span>
          </div>
        </div>

        <div class="actions">
          <button 
            mat-raised-button 
            color="warn" 
            (click)="joinEvent()" 
            [disabled]="isJoining || (event.occupied >= event.capacity)">
            <mat-icon>{{isJoining ? 'hourglass_empty' : 'add'}}</mat-icon>
            {{isJoining ? 'Joining...' : (event.occupied >= event.capacity ? 'Event Full' : 'Join Event')}}
          </button>
          <button 
            mat-raised-button 
            style="background-color: #f44336; color: white;" 
            (click)="leaveEvent()" 
            [disabled]="isLeaving">
            <mat-icon>{{isLeaving ? 'hourglass_empty' : 'exit_to_app'}}</mat-icon>
            {{isLeaving ? 'Leaving...' : 'Leave Event'}}
          </button>
          <button mat-stroked-button (click)="shareEvent()">
            <mat-icon>share</mat-icon>
            Share Event
          </button>
        </div>
      </div>
    </mat-card>

    <!-- Participants Section -->
    <mat-card class="participants-card">
      <div class="header">
        <h3>Participants</h3>
        <span class="count">{{ participants.length }}</span>
      </div>

      <div class="participant" *ngFor="let user of participants">
        <img [src]="user.avatar || 'assets/abstract-user-flat-4.svg'" alt="{{ user.name || user.username }}" />
        <div class="info">
          <span class="name">{{ user.name || user.username }}</span>
          <span class="badge">{{ user.level }}</span>
        </div>
      </div>
    </mat-card>
  </ng-container>
</div>
